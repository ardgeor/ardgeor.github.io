<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="http://0.0.0.0:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://0.0.0.0:4000/" rel="alternate" type="text/html" /><updated>2023-01-31T21:37:58+00:00</updated><id>http://0.0.0.0:4000/feed.xml</id><title type="html">Ardgeor’s</title><subtitle>Interests: reverse engineering, Android, ethical hacking, development, CTF, ...</subtitle><author><name>Gerardo Pinar Loriente</name></author><entry><title type="html">Why you should also protect the integrity of the native libraries</title><link href="http://0.0.0.0:4000/abusing-shared-object-in-android-applications/" rel="alternate" type="text/html" title="Why you should also protect the integrity of the native libraries" /><published>2023-01-16T00:00:00+00:00</published><updated>2023-01-16T00:00:00+00:00</updated><id>http://0.0.0.0:4000/abusing-shared-object-in-android-applications</id><content type="html" xml:base="http://0.0.0.0:4000/abusing-shared-object-in-android-applications/">&lt;!-- &lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/cover.png&quot;&gt;
&lt;/p&gt; --&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Nowadays, the developers of mobile applications handling sensitive information are usually aware of the security risks. 
Open-source and commercial solutions are involved during the build process, providing obfuscation and protections against techniques such as 
tampering, dynamic instrumentation, debugging, rooting, emulation, etc. These protection techniques have significantly evolved 
in the last years. Thus, bypassing these mechanisms usually requires advanced reverse engineering skills.&lt;/p&gt;

&lt;p&gt;However, there are still security holes that should not be overlooked, as they become low-hanging fruit that can be aimed by not necessarily
highly skilled attackers.&lt;/p&gt;

&lt;p&gt;An example of how what could be a banking application could be compromised is discussed in this article.&lt;/p&gt;

&lt;p&gt;This article is written with the purpose of raising awareness about the importance of taking care of the small details when developing products.
A huge defensive system might become useless if we leave an open window somewhere.&lt;/p&gt;

&lt;h2 id=&quot;proof-of-concept-poc&quot;&gt;Proof of Concept (PoC)&lt;/h2&gt;

&lt;h3 id=&quot;the-target-application-an-impregnable-bastion&quot;&gt;The target application: an impregnable bastion&lt;/h3&gt;

&lt;p&gt;For this demonstration, the target will be an application which requires entering a PIN code to authenticate a user.
The activity than contains the PIN pad is protected against screen captures through the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-Java&quot;&gt;
 window.setFlags(WindowManager.LayoutParams.FLAG_SECURE, 
      WindowManager.LayoutParams.FLAG_SECURE);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The explanation of the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; from the 
&lt;a href=&quot;https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_SECURE&quot;&gt;Android development site&lt;/a&gt;
is shown below:&lt;/p&gt;

&lt;!-- &lt;img src=&quot;/assets/images/abusing_shared_object/flag_secure.png&quot; width=&quot;1000&quot;&gt; --&gt;
&lt;p align=&quot;left&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/flag_secure.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;Hence, when this flag is set, capturing the screen is not allowed by the system. 
For instance, if we try to record the screen it will be shown in black; 
and if we try to take a screenshot through a button combination, it will not be allowed 
and a message like the one in the picture below will be shown:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/failed_screenshot.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;Furthermore, the application does not allow to proceed if the developer options are enabled (&lt;a href=&quot;https://developer.android.com/studio/command-line/adb&quot;&gt;adb&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Let us suppose that this application is protected with state-of-the-art techniques against rooting, hooking, debugging, tampering, etc.&lt;/p&gt;

&lt;p&gt;Thus, any attempt to hook or tamper with the APK would eventually trigger a security check, preventing the application from running in normal conditions.&lt;/p&gt;

&lt;p&gt;Let us also accept that the application is strongly obfuscated, and trying to understand how the security checks work would entail an arduous process of reverse engineering, which requires high skills.&lt;/p&gt;

&lt;h3 id=&quot;an-open-window-through-the-fortress&quot;&gt;An open window through the fortress&lt;/h3&gt;

&lt;p&gt;However, all this defensive effort described above might be in vain, as there is a small hole that leads inside of the fortress: the application has a native library whose integrity is not totally protected: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt;.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/libvuln.so.png&quot; /&gt;
&lt;/p&gt;

&lt;h3 id=&quot;loading-a-malicious-native-library&quot;&gt;Loading a malicious native library&lt;/h3&gt;

&lt;p&gt;The fact that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; can be modified without being detected, means that we could potentially alter the behaviour of the application. Moreover, the library &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; is loaded before the PIN pad is used. Hence, any modification we might induce, would be effective at the moment when the PIN pad is being used.&lt;/p&gt;

&lt;p&gt;Where to begin? Let us imagine that we have a rogue library, called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt;, which contains some malicious functions that we would like to be executed by the target application. Would it be possible? Well, the first problem to solve is that we need this library to be loaded in memory. In order to achieve this, the library &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; could be modified to declare an additional library as a dependency and, hence, make it to be loaded. This can be done with a tool called &lt;a href=&quot;https://github.com/lief-project/LIEF&quot;&gt;LIEF&lt;/a&gt;, created by the security engineer &lt;a href=&quot;https://www.romainthomas.fr/&quot;&gt;Romain Thomas&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As depicted below, LIEF takes as input the library to modify, and the name of the library to add as a dependency. The binary produced as a result, will include the name &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; as a needed library.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/lief.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;The code to produce this is shown below:&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;lief&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# (...)
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;libnative&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lief&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}/{}&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;so_input_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;so_input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;libnative&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;so_inject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# Injection!
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;libnative&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}/{}&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;so_output_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;so_output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By inspecting the strings of the binary produced, we can confirm that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; had been added to the list of libraries to load:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/strings_dep_added.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;In Android, the libraries embedded in an APK are placed within a directory dedicated for the specific application in the path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/app&lt;/code&gt;. For our case, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; is placed in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/app/ardgeor.libabuse.poc.targetapp-1/lib/arm64&lt;/code&gt;. For our attack, we would simply replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; by the “liefed” version. We would also copy &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; in the same directory.&lt;/p&gt;

&lt;p&gt;At this point, there are two aspects that need to be clarified:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Of course, we need to be &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; in order to write in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/app&lt;/code&gt;. However, this does not necessarily entail to bypass the root protection, as this action can be carried out when the application is not running. Thus, it would be enough for an attacker to just temporarily elevate privileges.&lt;/li&gt;
  &lt;li&gt;Actually, the native libraries are placed in the directory for the application in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/app&lt;/code&gt; as long as the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;android:extractNativeLibs&lt;/code&gt; is not set to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;false&lt;/code&gt; in the Android manifest. However, if we place the modified version of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; in this directory, this will be the binary loaded in memory, as that’s the preferred location.&lt;/li&gt;
&lt;/ol&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/lib_injection.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;Once the libraries have been placed in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/app/ardgeor.libabuse.poc.targetapp-1/lib/arm64&lt;/code&gt;, we can launch the application. 
A message in the log reveals that the library &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; is executing. No disruptive action is observed. At this point, we can inject our own code in the application and get it executed.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/librogue_loaded.png&quot; /&gt;
&lt;/p&gt;

&lt;h3 id=&quot;loading-a-malicious-dex-file&quot;&gt;Loading a malicious DEX file&lt;/h3&gt;

&lt;p&gt;So, we are already able to execute the code from our own native library. What would we like to do at this point?&lt;/p&gt;

&lt;p&gt;Thinking as an attacker about a real scenario, it would be great to disable the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; on the PIN activity and add functionality to take screenshots or record the screen, as well as support to send information to a server controlled by the attacker. As we plan to make calls at the Java layer, it would be more convenient to write Java code, generate a DEX file and load it from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt;.
The article &lt;a href=&quot;https://erev0s.com/blog/3-ways-for-dynamic-code-loading-in-android/&quot;&gt;&lt;em&gt;Three ways for dynamic code loading in Android&lt;/em&gt;&lt;/a&gt; may serve as inspiration for loading the DEX.&lt;/p&gt;

&lt;p&gt;Thus, Java reflection calls were included in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; to use, through the JNI, the class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DexClassLoader&lt;/code&gt; for loading our DEX &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rogue.dex&lt;/code&gt;. This is shown in the log snippet below:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/load_dex.png&quot; /&gt;
&lt;/p&gt;

&lt;h3 id=&quot;enabling-screen-captures&quot;&gt;Enabling screen captures&lt;/h3&gt;

&lt;p&gt;Good! Now we can inject code both in the native layer and in the Java layer!&lt;/p&gt;

&lt;p&gt;Our goal was to disable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; on the PIN activity. 
A simple approach could be to iteratively recover the current activity and disable the flag. 
This can be done through reflection calls to specific hidden Android API.
The result can be observed in the log snippet below:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/disable_flag_secure.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;And now we can capture the screen :)&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/screenshot.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;We could summarize this first part in three steps, as shown in the picture below:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Modify &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libvuln.so&lt;/code&gt; to indicate that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt; needs to be loaded.&lt;/li&gt;
  &lt;li&gt;From &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;librogue.so&lt;/code&gt;, load &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rogue.dex&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;From &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rogue.dex&lt;/code&gt;, recover the current activity and clear the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; from the corresponding window object.&lt;/li&gt;
&lt;/ol&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/attack_outline.png&quot; /&gt;
&lt;/p&gt;

&lt;h3 id=&quot;capturing-the-pin&quot;&gt;Capturing the PIN&lt;/h3&gt;

&lt;p&gt;We have seen how it was possible to disable the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; and take screenshots or record the screen. 
At this point there are different possibilities, let us go across them and analyze each particular case&lt;/p&gt;

&lt;h4 id=&quot;the-pin-pad-provides-a-visual-feedback-when-a-button-is-pressed&quot;&gt;The PIN pad provides a visual feedback when a button is pressed&lt;/h4&gt;

&lt;p&gt;The easiest case for the attacker would be when a visual feedback is produced when pressing a button of the PIN pad.
For instance, from the screen shown in the figure below, we can know that the button &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2&lt;/code&gt; was pressed, as a shadow appeared on the button.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/visual_fb_button_pressed.png&quot; /&gt;
&lt;/p&gt;

&lt;h4 id=&quot;the-pin-pad-does-not-provide-a-visual-feedback-when-a-button-is-pressed&quot;&gt;The PIN pad does not provide a visual feedback when a button is pressed&lt;/h4&gt;

&lt;p&gt;In the case that no visual effect is produced, such as a shadow or a color change, just being able to observe the screen would not be enough for an attacker to 
obtain the PIN. 
An additional capability will be required, related to where the user touched on the screen.&lt;/p&gt;

&lt;p&gt;There exists a feature that satisfies this need: the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option, or “show taps”. This can be enabled through the developer options menu:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/show_taps.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;This apparently solved the problem, except that we had said that the application did not allow the developer options to be enabled…&lt;/p&gt;

&lt;h5 id=&quot;enabling-the-show_touches-feature-without-the-developer-options&quot;&gt;Enabling the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; feature without the developer options&lt;/h5&gt;

&lt;p&gt;But we had also mentioned that this attack needs the ability to temporarily become root. A root privilege allows to activate the 
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; setting. However, a shell session &lt;strong&gt;independent from ADB&lt;/strong&gt; is needed.&lt;/p&gt;

&lt;p&gt;Let us think again of a real scenario, let’s imagine an attacker that has a remote shell session on the phone through e.g. using the SSH protocol.
The attacker must become root, and the privilege obtained must allow to edit the settings. 
If this is achieved, the following command will activate the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option:&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;se&quot;&gt;\#&lt;/span&gt;  content insert &lt;span class=&quot;nt&quot;&gt;--uri&lt;/span&gt; content://settings/system &lt;span class=&quot;nt&quot;&gt;--bind&lt;/span&gt; name:s:show_touches &lt;span class=&quot;nt&quot;&gt;--bind&lt;/span&gt; value:i:1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or also:&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;se&quot;&gt;\#&lt;/span&gt;  settings put system show_touches 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A couple of comments about this:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;If the phone reboots, the change is persistent, meaning that the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option will still be active.&lt;/li&gt;
  &lt;li&gt;If the developer options are enabled, and then disabled, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option will be disabled.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Well, at this point nothing prevents us from capturing the PIN, as shown in the picture below, where a tap appears on the digit &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2&lt;/code&gt;:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/capture_touch.png&quot; /&gt;
&lt;/p&gt;

&lt;h4 id=&quot;further-discussion&quot;&gt;Further discussion&lt;/h4&gt;

&lt;p&gt;There are more possibilities that could make the attack unfeasible or even easier. 
For instance, if the position of the buttons is always the same, we don’t really need to * see * the PIN pad, it is enough to see the taps, and 
then derive the button that was pressed.&lt;/p&gt;

&lt;p&gt;Let us see an example. The screen shown below has been captured. As we can see, the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; has not be disabled, but the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option has been enabled.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/not_visible.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;If the position of the buttons is static, we can just superimpose a template of the PIN pad on the screen capture, and we get obtain the button that was pressed. 
Or we can directly infer it from the screen capture :)&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/not_visible_with_template.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;A more complicated case would be when there is no visual feedback and also the position of the buttons is not predictable. 
In this case, we would again need both disabling the flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt;, in order to see where each button is placed; 
and also enable the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option, to obtain visual feedback. An example is shown below:&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/unpredictable.png&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;Finally, if the application checks the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option and refuses to execute normally if it is enabled; and there is no visual feedback on the PIN pad; then, in this case, retrieving the PIN from the screen is, a priori, not possible.&lt;/p&gt;

&lt;p&gt;The relevant cases are summarized in the table below:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; enabled&lt;/th&gt;
      &lt;th&gt;PIN pad buttons at a fixed position&lt;/th&gt;
      &lt;th&gt;Visual feedback&lt;/th&gt;
      &lt;th&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; detected&lt;/th&gt;
      &lt;th&gt;Attack path&lt;/th&gt;
      &lt;th&gt; &lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;Disable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;Activate &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;X&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;Not needed&lt;/td&gt;
      &lt;td&gt;Not needed&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;X&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Not needed&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;X&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;Not needed&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;X&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;N/A&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;X&lt;/td&gt;
      &lt;td&gt;No&lt;/td&gt;
      &lt;td&gt;Yes&lt;/td&gt;
      &lt;td&gt;Attack not possible&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;summing-up&quot;&gt;Summing up&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;The attack paths presented here take advantage from neglected security holes. 
Namely, absence of integrity checks on the shared objects (*.so), and absence of a explicit check on the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option to be disabled
(just a check on the developer options is not enough!).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The attack require a shell session as root. Actions will be carried out when the target application is not in use, so no need to worry about security checks (depending on how root has been obtained).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;Depending on the exact case (see the different cases discussed above), different additional requirements would be needed for the attack to be applicable:
    &lt;ul&gt;
      &lt;li&gt;If disabling the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FLAG_SECURE&lt;/code&gt; flag is required, an unprotected shared object (being loaded before the PIN pad is used) is needed.&lt;/li&gt;
      &lt;li&gt;If the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;show_touches&lt;/code&gt; option is needed, the attack privilege must allow to edit the system settings. Moreover, a shell session &lt;strong&gt;not related to ADB&lt;/strong&gt; is needed.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The attack can apply to any application, without customization, as long as the required conditions are fulfilled.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;No reverse engineering is required.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;what-else&quot;&gt;What else?&lt;/h2&gt;

&lt;p&gt;Note that if we are able to inject code, this opens the door to new attacks :)&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Keep thinking about security, don’t take it for granted.&lt;/li&gt;
  &lt;li&gt;Pay attention to the small details. Is there an easy way in somewhere?&lt;/li&gt;
  &lt;li&gt;Keep this picture in sight:&lt;/li&gt;
&lt;/ul&gt;

&lt;p align=&quot;center&quot;&gt;
&lt;img src=&quot;/assets/images/abusing_shared_object/breach.png&quot; /&gt;
&lt;/p&gt;</content><author><name>Gerardo Pinar Loriente</name></author><category term="Android" /><category term="Tampering" /><category term="Injection" /><category term="Bypass" /><summary type="html">In this article we will see how a native library can be abused to inject code and capture the PIN code from an Android application, without triggering the protections. All without doing reverse engineering.</summary></entry></feed>